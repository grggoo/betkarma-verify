<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BetKarma - Provably Fair Anchors</title>
    <script>
      (function() {
        var params = new URLSearchParams(location.search);
        var lang = (params.get("lang") || "").toLowerCase();
        if (lang !== "ru") lang = "en";
        var T = {
          en: {
            pageTitle: "BetKarma - Provably Fair Anchors",
            headerTagline: "Public append-only log of seedset commits/reveals and rules snapshots.",
            fairPlayTitle: "Our fair play commitment",
            fairPlayStatement: "We publish every game result to a public log so you can verify that outcomes are random and correct. Before a round starts, we commit a hash of the server seed. After the round ends, we reveal the seed and publish it here. Anyone can recompute the outcome and confirm it matches.",
            fairPlayWhat: "What this proves",
            fairPlayWhatText: "That the outcome was determined by a cryptographically random process, not chosen afterward. The server could not have changed the result once your bet was placed.",
            fairPlayVerify: "How to verify",
            fairPlayVerifyText: "In the app: History → Casino. Each bet has a receipt. Copy it and paste it in the Verifier below. We compare it to our published anchors and recompute the outcome.",
            fairPlayDisclosure: "Why not instant?",
            fairPlayDisclosureText: "We reveal seeds and publish to this log once per hour, after the seedset rotates and all active rounds finish. That protects in-progress games. Your bets are verifiable within about an hour.",
            structure: "Structure:",
            sectionVerifier: "Verifier",
            verifierOpen: "Open verifier (paste a receipt JSON)",
            sectionAnchors: "Anchors",
            sectionHowToVerify: "How to verify",
            step1: "Get a receipt from the app or verify endpoint (gameId, seedSetId, serverSeedHash, rulesVersion, rngVersion).",
            step2: "Open anchors/<gameId>/seedsets.jsonl and find the line with this seedSetId and serverSeedHashHex.",
            step3: "When the seedset is revealed, reveals.jsonl will include serverSeedHex. Verify: sha256(serverSeedHex) == serverSeedHashHex.",
            step4: "Recompute the outcome using the public rules and receipts.",
            sectionQuickReveal: "Quick reveal hash check (sha256)",
            pasteRevealLine: "Paste one JSON line from reveals.jsonl and click Verify.",
            btnVerify: "Verify reveal hash",
            loading: "Loading...",
            noCommits: "No commits yet for this game.",
            revealedYes: "YES",
            revealedNo: "NO",
            resultOk: "OK",
            resultMismatch: "MISMATCH",
            errorLabel: "Error:",
            errorLoading: "Error loading anchors:"
          },
          ru: {
            pageTitle: "BetKarma — Якоря Provably Fair",
            headerTagline: "Публичный дополняемый лог коммитов/раскрытий сидов и снимков правил.",
            fairPlayTitle: "Наш принцип честной игры",
            fairPlayStatement: "Мы публикуем каждый результат в открытый лог, чтобы вы могли убедиться, что исходы случайны и корректны. До начала раунда мы фиксируем хеш серверного сида. После завершения раунда — раскрываем сид и публикуем здесь. Любой может пересчитать исход и проверить соответствие.",
            fairPlayWhat: "Что это доказывает",
            fairPlayWhatText: "Что исход определён криптографически случайным процессом, а не подобран после факта. Сервер не мог изменить результат после вашей ставки.",
            fairPlayVerify: "Как проверить",
            fairPlayVerifyText: "В приложении: История → Казино. У каждой ставки есть чек. Скопируйте и вставьте в верификатор ниже. Мы сверим его с публичными якорями и пересчитаем исход.",
            fairPlayDisclosure: "Почему не мгновенно?",
            fairPlayDisclosureText: "Раскрытие сидов и публикация в этот лог — раз в час, после ротации сидсета и завершения всех активных раундов. Так защищаются идущие игры. Ваши ставки можно проверить примерно в течение часа.",
            structure: "Структура:",
            sectionVerifier: "Верификатор",
            verifierOpen: "Открыть верификатор (вставьте JSON чека)",
            sectionAnchors: "Якоря",
            sectionHowToVerify: "Как проверить",
            step1: "Получите чек в приложении или через verify endpoint (gameId, seedSetId, serverSeedHash, rulesVersion, rngVersion).",
            step2: "Откройте anchors/<gameId>/seedsets.jsonl и найдите строку с этим seedSetId и serverSeedHashHex.",
            step3: "Когда сидсет раскрыт, в reveals.jsonl будет serverSeedHex. Проверьте: sha256(serverSeedHex) == serverSeedHashHex.",
            step4: "Пересчитайте исход по публичным правилам и чекам.",
            sectionQuickReveal: "Быстрая проверка хеша раскрытия (sha256)",
            pasteRevealLine: "Вставьте одну строку JSON из reveals.jsonl и нажмите Проверить.",
            btnVerify: "Проверить хеш раскрытия",
            loading: "Загрузка...",
            noCommits: "Пока нет коммитов для этой игры.",
            revealedYes: "ДА",
            revealedNo: "НЕТ",
            resultOk: "ОК",
            resultMismatch: "НЕ СОВПАДАЕТ",
            errorLabel: "Ошибка:",
            errorLoading: "Ошибка загрузки якорей:"
          }
        };
        window.__lang = lang;
        window.__T = T[lang] || T.en;
        document.documentElement.lang = lang;
        document.title = window.__T.pageTitle;
      })();
    </script>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        margin: 0;
        background: #0b0f17;
        color: #e8eefc;
      }
      a {
        color: #9fd3ff;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      header {
        padding: 28px 18px 32px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.02);
      }
      .header-intro {
        max-width: 640px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }
      .header-intro h2 {
        font-size: 15px;
        font-weight: 600;
        margin: 0 0 10px;
        color: #e8eefc;
      }
      .header-intro p {
        font-size: 14px;
        line-height: 1.55;
        margin: 0 0 14px;
        color: rgba(232, 238, 252, 0.9);
      }
      .header-intro p:last-child {
        margin-bottom: 0;
      }
      .header-intro .note {
        font-size: 13px;
        color: rgba(232, 238, 252, 0.75);
      }
      main {
        max-width: 980px;
        margin: 0 auto;
        padding: 18px;
      }
      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }
      .card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 14px;
        background: rgba(255, 255, 255, 0.02);
      }
      .muted {
        color: rgba(232, 238, 252, 0.7);
      }
      code {
        background: rgba(255, 255, 255, 0.06);
        padding: 2px 6px;
        border-radius: 6px;
      }
      .ok {
        color: #7cffb2;
      }
      .bad {
        color: #ff7ca3;
      }
      .row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }
      .pill {
        font-size: 12px;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      textarea {
        width: 100%;
        min-height: 110px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.2);
        color: #e8eefc;
        padding: 10px;
      }
      button {
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: #e8eefc;
        padding: 9px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      button:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: rgba(0, 0, 0, 0.25);
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>
  <body>
    <header>
      <div style="max-width: 980px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
          <div>
            <div id="i18n-pageTitle" style="font-size: 20px; font-weight: 700;"></div>
            <div id="i18n-headerTagline" class="muted" style="margin-top: 6px;"></div>
            <div class="muted" style="margin-top: 10px;">
              <span id="i18n-structure"></span>
              <code>anchors/&lt;gameId&gt;/{seedsets,reveals}.jsonl</code>,
              <code>rules/&lt;rulesVersion&gt;.json</code>
            </div>
          </div>
          <div>
            <span class="pill"><a id="langEn" href="?lang=en">EN</a> <span class="muted" style="margin: 0 4px">|</span> <a id="langRu" href="?lang=ru">RU</a></span>
          </div>
        </div>
        <div id="fairPlayBlock" class="header-intro">
          <h2 id="i18n-fairPlayTitle"></h2>
          <p id="i18n-fairPlayStatement"></p>
          <p><strong id="i18n-fairPlayWhat"></strong> <span id="i18n-fairPlayWhatText"></span></p>
          <p><strong id="i18n-fairPlayVerify"></strong> <span id="i18n-fairPlayVerifyText"></span></p>
          <p class="note"><strong id="i18n-fairPlayDisclosure"></strong> <span id="i18n-fairPlayDisclosureText"></span></p>
        </div>
      </div>
    </header>

    <main>
      <h2 style="margin: 22px 0 10px;" id="i18n-sectionVerifier"></h2>
      <p class="muted">
        <a id="verifierLink" href=""> </a>
      </p>

      <h2 style="margin: 14px 0 10px;" id="i18n-sectionAnchors"></h2>
      <div id="games" class="grid"></div>

      <h2 style="margin: 22px 0 10px;" id="i18n-sectionHowToVerify"></h2>
      <ol class="muted">
        <li id="i18n-step1"></li>
        <li id="i18n-step2"></li>
        <li id="i18n-step3"></li>
        <li id="i18n-step4"></li>
      </ol>

      <h2 style="margin: 22px 0 10px;" id="i18n-sectionQuickReveal"></h2>
      <div id="i18n-pasteRevealLine" class="muted" style="margin-bottom: 8px;"></div>
      <textarea
        id="revealLine"
        placeholder='{"ts":"...","gameId":"coinflip38","seedSetId":"...","serverSeedHex":"...","serverSeedHashHex":"..."}'
      ></textarea>
      <div style="margin-top: 10px;">
        <button id="btnVerify"></button>
      </div>
      <pre id="verifyOut" class="muted" style="margin-top: 10px;"></pre>
    </main>

    <script>
      (function applyI18n() {
        var T = window.__T;
        var lang = window.__lang || "en";
        if (!T) return;
        var map = {
          "i18n-pageTitle": "pageTitle",
          "i18n-headerTagline": "headerTagline",
          "i18n-structure": "structure",
          "i18n-fairPlayTitle": "fairPlayTitle",
          "i18n-fairPlayStatement": "fairPlayStatement",
          "i18n-fairPlayWhat": "fairPlayWhat",
          "i18n-fairPlayWhatText": "fairPlayWhatText",
          "i18n-fairPlayVerify": "fairPlayVerify",
          "i18n-fairPlayVerifyText": "fairPlayVerifyText",
          "i18n-fairPlayDisclosure": "fairPlayDisclosure",
          "i18n-fairPlayDisclosureText": "fairPlayDisclosureText",
          "i18n-sectionVerifier": "sectionVerifier",
          "i18n-sectionAnchors": "sectionAnchors",
          "i18n-sectionHowToVerify": "sectionHowToVerify",
          "i18n-step1": "step1",
          "i18n-step2": "step2",
          "i18n-step3": "step3",
          "i18n-step4": "step4",
          "i18n-sectionQuickReveal": "sectionQuickReveal",
          "i18n-pasteRevealLine": "pasteRevealLine"
        };
        Object.keys(map).forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.textContent = T[map[id]] || "";
        });
        var btn = document.getElementById("btnVerify");
        if (btn) btn.textContent = T.btnVerify || "Verify reveal hash";
        var verifierLink = document.getElementById("verifierLink");
        if (verifierLink) {
          verifierLink.href = "verify.html?lang=" + lang;
          verifierLink.textContent = T.verifierOpen || "Open verifier (paste a receipt JSON)";
        }
      })();

      const GAMES = [
        { id: "coinflip38", title: "coinflip38" },
        { id: "karmaladder", title: "karmaladder" },
        { id: "karmapoker", title: "karmapoker" },
      ];

      function el(tag, attrs = {}, children = []) {
        const n = document.createElement(tag);
        Object.entries(attrs).forEach(([k, v]) => {
          if (k === "class") n.className = v;
          else if (k === "html") n.innerHTML = v;
          else n.setAttribute(k, v);
        });
        children.forEach((c) => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
        return n;
      }

      async function fetchJsonl(url) {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`${url}: HTTP ${res.status}`);
        const txt = await res.text();
        const lines = txt
          .split("\n")
          .map((s) => s.trim())
          .filter(Boolean);
        return lines.map((l) => JSON.parse(l));
      }

      function shortHex(s, n = 10) {
        if (!s || typeof s !== "string") return "-";
        return s.length <= n * 2 + 3 ? s : `${s.slice(0, n)}...${s.slice(-n)}`;
      }

      async function renderGames() {
        const host = document.getElementById("games");
        host.innerHTML = "";

        for (const g of GAMES) {
          const seedsetsUrl = `anchors/${g.id}/seedsets.jsonl`;
          const revealsUrl = `anchors/${g.id}/reveals.jsonl`;

          const card = el("div", { class: "card" }, [
            el("div", { class: "row" }, [
              el("div", { html: `<b>${g.title}</b>` }),
              el("div", { class: "pill" }, ["anchors"]),
            ]),
            el("div", { class: "muted", style: "margin-top:8px;" }, [
              el("div", {}, [
                el("a", { href: seedsetsUrl }, ["seedsets.jsonl"]),
                document.createTextNode(" | "),
                el("a", { href: revealsUrl }, ["reveals.jsonl"]),
              ]),
            ]),
            el("div", { class: "muted", style: "margin-top:10px;" }, [window.__T ? window.__T.loading : "Loading..."]),
          ]);

          host.appendChild(card);

          try {
            const [seedsets, reveals] = await Promise.all([fetchJsonl(seedsetsUrl), fetchJsonl(revealsUrl)]);

            const lastCommit = seedsets[seedsets.length - 1] || null;
            const revealMap = new Map(reveals.map((r) => [r.seedSetId, r]));
            const lastCommitReveal = lastCommit ? revealMap.get(lastCommit.seedSetId) : null;

            const T = window.__T || {};
            const lines = [];
            lines.push(`commits: ${seedsets.length}, reveals: ${reveals.length}`);
            if (lastCommit) {
              lines.push(`latest seedSetId: ${lastCommit.seedSetId}`);
              lines.push(`latest hash: ${shortHex(lastCommit.serverSeedHashHex)}`);
              lines.push(`latest ts: ${lastCommit.ts}`);
              lines.push(`revealed: ${lastCommitReveal ? (T.revealedYes || "YES") : (T.revealedNo || "NO")}`);
            } else {
              lines.push(T.noCommits || "No commits yet for this game.");
            }

            card.lastChild.textContent = lines.join("\n");
          } catch (e) {
            const T = window.__T || {};
            card.lastChild.textContent = (T.errorLoading || "Error loading anchors:") + " " + (e && e.message ? e.message : e);
          }
        }
      }

      function hexToBytes(hex) {
        const clean = hex.trim().toLowerCase();
        if (!/^[0-9a-f]*$/.test(clean) || clean.length % 2 !== 0) {
          throw new Error("serverSeedHex must be even-length hex");
        }
        const out = new Uint8Array(clean.length / 2);
        for (let i = 0; i < out.length; i += 1) {
          out[i] = parseInt(clean.slice(i * 2, i * 2 + 2), 16);
        }
        return out;
      }
      function bytesToHex(bytes) {
        return [...bytes].map((b) => b.toString(16).padStart(2, "0")).join("");
      }
      async function sha256HexOfHexBytes(seedHex) {
        const bytes = hexToBytes(seedHex);
        const buf = await crypto.subtle.digest("SHA-256", bytes);
        return bytesToHex(new Uint8Array(buf));
      }

      document.getElementById("btnVerify").addEventListener("click", async () => {
        const out = document.getElementById("verifyOut");
        const T = window.__T || {};
        out.textContent = "";
        try {
          const line = JSON.parse(document.getElementById("revealLine").value);
          const computed = await sha256HexOfHexBytes(line.serverSeedHex);
          const ok = computed.toLowerCase() === String(line.serverSeedHashHex || "").toLowerCase();
          out.textContent =
            `computed sha256(serverSeedHex): ${computed}\n` +
            `anchored serverSeedHashHex:     ${line.serverSeedHashHex}\n` +
            `result: ${ok ? (T.resultOk || "OK") : (T.resultMismatch || "MISMATCH")}`;
          out.className = ok ? "ok" : "bad";
        } catch (e) {
          out.className = "bad";
          out.textContent = (T.errorLabel || "Error:") + " " + (e && e.message ? e.message : e);
        }
      });

      renderGames();
    </script>
  </body>
</html>
